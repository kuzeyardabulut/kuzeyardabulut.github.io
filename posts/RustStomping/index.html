<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="DLL Hollowing with Rust Language: Stealth Injection" /><meta property="og:locale" content="en" /><meta name="description" content="This will be the first blog on this website. I take DLL Hollowing topic for my first blog because I didn’t see any articles about DLL Hollowing with rust-lang so I decided to talk about that. This project is a bit different than others because we are not creating threads. We are just changing the active module’s permissions and injecting our shellcode to this module without changing headers. When this shellcode is executed, it will load your DLL and create your real target process." /><meta property="og:description" content="This will be the first blog on this website. I take DLL Hollowing topic for my first blog because I didn’t see any articles about DLL Hollowing with rust-lang so I decided to talk about that. This project is a bit different than others because we are not creating threads. We are just changing the active module’s permissions and injecting our shellcode to this module without changing headers. When this shellcode is executed, it will load your DLL and create your real target process." /><link rel="canonical" href="https://kuzey.rs/posts/RustStomping/" /><meta property="og:url" content="https://kuzey.rs/posts/RustStomping/" /><meta property="og:site_name" content="Cyber Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-06-11T00:21:00+03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="DLL Hollowing with Rust Language: Stealth Injection" /><meta name="twitter:site" content="@kuzeyardabulut" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-06-11T00:21:00+03:00","datePublished":"2023-06-11T00:21:00+03:00","description":"This will be the first blog on this website. I take DLL Hollowing topic for my first blog because I didn’t see any articles about DLL Hollowing with rust-lang so I decided to talk about that. This project is a bit different than others because we are not creating threads. We are just changing the active module’s permissions and injecting our shellcode to this module without changing headers. When this shellcode is executed, it will load your DLL and create your real target process.","headline":"DLL Hollowing with Rust Language: Stealth Injection","mainEntityOfPage":{"@type":"WebPage","@id":"https://kuzey.rs/posts/RustStomping/"},"url":"https://kuzey.rs/posts/RustStomping/"}</script><title>DLL Hollowing with Rust Language: Stealth Injection | Cyber Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Cyber Blog"><meta name="application-name" content="Cyber Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/terminal-icon.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Cyber Blog</a></div><div class="site-subtitle font-italic">Cybersecurity related blogs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/disclaimer/" class="nav-link"> <i class="fa-fw fas fa-gavel ml-xl-3 mr-xl-3 unloaded"></i> <span>DISCLAIMER</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/kuzeyardabulut" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/kuzeyardabulut" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-5" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/kuzeyardabulut/" aria-label="linkedin" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>DLL Hollowing with Rust Language: Stealth Injection</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>DLL Hollowing with Rust Language: Stealth Injection</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Kuzey Arda Bulut </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jun 11, 2023, 12:21 AM +0300" >Jun 11, 2023<i class="unloaded">2023-06-11T00:21:00+03:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1942 words">10 min read</span></div></div><div class="post-content"><p>This will be the first blog on this website. I take DLL Hollowing topic for my first blog because I didn’t see any articles about DLL Hollowing with rust-lang so I decided to talk about that. This project is a bit different than others because we are not creating threads. We are just changing the active module’s permissions and injecting our shellcode to this module without changing headers. When this shellcode is executed, it will load your DLL and create your real target process.</p><p>Just before starting you can access my codes in <a href="https://github.com/kuzeyardabulut/rust-dll-hollowing">here</a>.</p><h2 id="requirements">Requirements</h2><p>For this setup, you will need the following:</p><ul><li>Rust Programming Language (https://www.rust-lang.org/)<li>DLL Hollowing Project (https://github.com/kuzeyardabulut/rust-dll-hollowing)</ul><h2 id="setup">Setup</h2><p>First, you should clone <a href="https://github.com/kuzeyardabulut/rust-dll-hollowing">this</a> repository then you will compile the codes like below:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd </span>rust-dll-hollowing
cargo build <span class="nt">--release</span>
</pre></table></code></div></div><p>Now we compile <a href="https://github.com/kuzeyardabulut/rust-dll-hollowing">this</a> project but we need a shellcode that is going to call the <em>LoadLibrary</em> function. For creating a shellcode, we are going to use <code class="language-plaintext highlighter-rouge">msfvenom</code>. Execute the following commands in your bash terminal.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>msfvenom <span class="nt">-p</span> windows/x64/loadlibrary <span class="nv">DLL</span><span class="o">=</span>C:<span class="se">\\</span>Users<span class="se">\\</span>Public<span class="se">\\</span><span class="k">in</span>.dll <span class="nv">PrependMigrate</span><span class="o">=</span><span class="nb">true </span><span class="nv">PrependMigrateProc</span><span class="o">=</span>explorer.exe <span class="nt">-f</span> rust ‐-bad-chars <span class="s1">'\x00\x0a\x0d'</span>
</pre></table></code></div></div><p>If you successfully complete all of these steps then you are ready!</p><h2 id="injection-method">Injection Method</h2><p>When you read the well-known Windows Injection Methods, you can see many methods for malware development and game cheats. You can run your DLLs in many ways, but when loading or running those DLLs, your injectors should be undetectable. In general, many basic and known injection methods can be detected by antis.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/known_inject.png" alt="Top 10 Injection Methods" /> <em>Figure 1: Generally Known Injection Methods</em></p><p>Therefore, attackers usually try to make them undetectable by making minor changes to known methods and this makes the job of cyber security experts difficult. For this, I will describe a method that I have differentiated by changing it so that cybersecurity experts can better understand the attackers’ perspective.</p><h3 id="module-stomping-overview">Module Stomping Overview</h3><p>Module Stomping is a well-known injection method. In this technique, you are injecting your shell code under your Legit DLL. This way, your shellcode will run under the Legit DLL.</p><p>First, your injector allocates space with <strong><em>VirtualAllocEx</em></strong> function then it will write your DLL’s path to allocated space with <strong><em>WriteProcessMemory</em></strong> function for loading your Legit DLL (for example: kernel32.dll, amsi.dll) to your target process. After that, the injector calls <strong><em>CreateRemoteThread</em></strong> function for creating threads. If the injector is successful to create a thread then it will suspend the thread. After all that, the injector will calculate the target Legit DLLs <strong><em>AddressOfEntryPoint</em></strong> (points to the beginning of the <strong>.text</strong> section) and will write your shellcode to that calculated address.</p><ul><li><strong>VirtualAllocEx</strong>: It allocates space under the region of memory within the virtual address space of a specified process. If the target address is <em>null</em>, the function determines where to allocate the region.<li><strong>WriteProcessMemory</strong>: The entire field to be written must be accessible and free, otherwise the operation will fail.<li><strong>AddressOfEntryPoint</strong>: The AddressOfEntryPoint is a specific memory address within an executable file where the execution of the program begins after it is loaded into memory. It serves as the entry point for the operating system to start executing the program’s instructions. We are going to calculate this address from NT Headers in <a href="#code-review">Code Review</a> part of our article.<li><strong>CreateRemoteThread</strong>: The CreateRemoteThread is a function in the Windows operating system that allows a process to create a thread in a different process, enabling it to execute code in the context of that remote process.<li><strong>ResumeThread</strong>: ResumeThread is a function in Windows operating systems that allows a suspended thread to resume execution.</ul><p>At this stage, we have completed all our injection processes, we just need to change the Suspend state of our thread using the <strong><em>ResumeThread</em></strong> function. Once finished, your shellcode will run under a Legal DLL. The headers of these Legitimate DLLs will remain the same, thus making it difficult for malicious shellcodes to be detected.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/stomping_example.png" alt="Module Stomping Example" /> <em>Figure 2: Shellcode is running under the amsi.dll</em></p><h4 id="pros-and-cons-of-the-module-stomping">Pros And Cons Of The Module Stomping</h4><p>As with any method, this method has its pros and cons. As with any method, this method has its pros and cons. The pros and cons of the techniques are usually examined by cybersecurity experts and appropriate detectors are coded.</p><p>Pros:</p><ul><li>Your Shellcode is running under a Legit DLL. This makes it less likely to be detected.<li>You don’t need to use a <strong>VirtualProtectEx</strong> again as you have granted the permissions appropriately to write the shellcode when allocating the space.<li>Since you do the injection operations while the thread is suspended, the probability of detection may decrease.</ul><p>Cons:</p><ul><li>You load a Legit DLL into a Legit Process. This may sound normal at first, but we should not forget that our injector, which is a non-Legit process, is trying to do all this, and many functions (<em>VirtualAllocEx</em>, <em>CreateRemoteThread</em>…) are used while the injector is doing all this.<li>An extra and unusual thread is created in the process.</ul><h3 id="addressofentrypoint-injection-overview">AddressOfEntryPoint Injection Overview</h3><p>AddressOfEntryPoint Injection is a bit different than Module Stomping because when you’re doing that injection method you don’t need to Allocate any space from memory and you don’t need to create or suspend your threads. You can write shellcode directly by changing the permissions to the existing module.</p><p>You can review this techniques code in the <a href="#code-review">Code Review</a> section of our article.</p><p>First, you must set a target module. it may be better if this module does not run as a thread. Secondly, you should check the module’s permissions. If the module’s permission of the checked module is not <strong>PAGE_EXECUTE_READWRITE</strong> then change the permission of the module with the <strong>VirtualProtectEx</strong> function. Secondly, read the process memory with <strong>ReadProcessMemory</strong> function then calculate the <em>NTHeaders</em> with return values. Then calculate <em>AddressOfEntryPoint</em> from <em>NTHeaders</em>. After all, write your shellcode to <strong>AddressOfEntryPoint</strong> address (start of the <strong>.text</strong> section) with <strong>WriteProcessMemory</strong> function, and your injection process is done. Now your shellcode will run when the process tries to use the module whose shellcode you inject.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/address_of_entity.png" alt="AddressOfEntryPoint Example" /> <em>Figure 3: Shellcode injected to urlmon.dll</em></p><h4 id="pros-and-cons-of-the-addressofentrypoint-injection">Pros And Cons Of The AddressOfEntryPoint Injection</h4><p>This method also has pros and cons compared to module stomping.</p><p>Pros:</p><ul><li>Your Shellcode is running under a Legit DLL. This makes it less likely to be detected.<li>You don’t need to use a <strong>VirtualAllocate</strong>.<li>You don’t need to load Legit DLL first.<li>You don’t need to create a thread.</ul><p>Cons:</p><ul><li>You need to change the permission of the existing module.<li>You are going to change the running modules’ permission.</ul><h2 id="code-review">Code Review</h2><p>After talking about the similarities of the techniques, we can now move on to the review part of our code.</p><p>When we first look at our Workspace from Github, we see two different projects named “encrypt shellcode” and “injector”. The “encrypt shellcode” project encrypts our shellcode and prints us this encrypted shellcode. You can review it by yourself. The “injector” project is our <strong>AddressOfEntryPoint Injector</strong>. So we are going to review the “injection” project in this article.</p><h3 id="mainrs">main.rs</h3><p>In main file, we are completing all of the <strong>Injection</strong> things. Now i will explain the code pieces one by one. Let’s Start !</p><p>At the beginning of the file, the necessary libraries are imported, const variables are determined, and a macro named <strong>print_permission</strong> is written. Let’s start by explaining the variables first. These variables are named <strong>BUF</strong> and <strong>TARGET_PROCESS_NAME</strong>. <strong>TARGET_PROCESS_NAME</strong> contains the name of the process where the shellcode will be injected. <strong>BUF</strong> is the encrypted version of your shellcode. If we look at our macro, this macro tries to change the permissions of the target module using the <strong>VirtualProtectEx</strong> function.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/mainrs-1.png" alt="Part 1" /> <em>Figure 4: Head of main.rs</em></p><p>Now, we have a function whose name is <strong>everything</strong>. In this function, we are decoding your AES-encrypted shellcode with our functions.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/mainrs-2.png" alt="Part 2" /> <em>Figure 5: everything</em></p><p>Here we are starting the Injection! First, we are getting the target processes ID by processes name. After that, we are getting the module’s base address and we are opening the target process with <strong>OpenProcess</strong> function. Then we are saving the process handle and calculate the <strong>MEMORY_BASIC_INFORMATION</strong>.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/mainrs-3.png" alt="Part 3" /> <em>Figure 6: Calculating the MemoryInfo</em></p><p>We are getting <strong>MEMORY_BASIC_INFORMATION</strong> from the module’s base address with <strong>VirtualQueryEx</strong> function. Then we try to control the memory protections and change the memory protections with the <strong>print permission</strong> function, which is the function we mentioned at the beginning. After that we are getting memory pieces of information with <strong>ReadProcessMemory</strong> function to calculate <strong>AddressOfEntryPoint</strong>.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/mainrs-4.png" alt="Part 4" /> <em>Figure 7: Change Permission and Get MemoryInfo</em></p><p>We read the memory and got <strong>DOS_HEADERS</strong>. If we want to get <strong><em>AddressOfEntity</em></strong> we need to calculate <strong>NT_HEADERS</strong>. If we want to calculate <strong>NT_HEADERS</strong> we should use <em>e_lfanew</em> which is under <strong>DOS_HEADER</strong>.</p><ul><li><strong><em>e_lfanew</em></strong>: This is the member of the DOS header structure within a PE (Portable Executable) file. This member is a 32-bit signed integer located at offset 0x3C (60 decimal) in the DOS header. “e_lfanew” specifies the offset from which the NT (New Technology) headers start in the file. The PE loader uses the value within “e_lfanew” to <strong><em>locate the beginning of the NT headers</em></strong> and then parse the file header to understand the structure of the executable file. This value is important for the loader because it determines where to look for the file header.</ul><p>So we will collect the base address with <em>e_lfanew</em> and find the starting address of <strong>NT_HEADERS</strong>. When we find the <strong>NT_HEADERS</strong>, we will calculate the <strong><em>AddressOfEntryPoint</em></strong>. After that we will be summing the base address and the <strong>AddressOfEntryPoint</strong> we will get the beginning of the <strong>.text</strong> section.</p><p>We will print out the important addresses which we found and write our shellcode to memory with the <strong><em>WriteProcessMemory</em></strong> function from where the <strong>.text</strong> section starts.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/mainrs-5.png" alt="Part 5" /> <em>Figure 8: Write Your Shellcode</em></p><p>When your module will be used, the shellcode will work on your target machine. This way the shellcode will run under the Legit DLL, making it harder to detect. Let’s look at <strong>security.rs</strong> to see Security Protections.</p><h3 id="securityrs">security.rs</h3><p>Now, we will review our security protections. First, we are importing our libraries. Then we are writing a function whose name is <strong>anti_debugger</strong>. This function checks if the debugger is running so that the binary is not examined by the debugger.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/securityrs-1.png" alt="Part 1" /> <em>Figure 9: Checks Debugger</em></p><p>After checking the debugger, we are actively checking the processes running in the system. If some unwanted processes are running, we close the program without injection.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/securityrs-2.png" alt="Part 2" /> <em>Figure 10: Checking Processes</em></p><p>You can see the unwanted process list below. Also, you can add some process names as unwanted.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/securityrs-3.png" alt="Part 3" /> <em>Figure 11: Unwanted Processes Lists</em></p><h3 id="encryptrs">encrypt.rs</h3><p>Shellcodes created with <strong>msfvenom</strong> and embedded in the project can be easily understood by antiviruses. However, if these shellcodes are encoded, it becomes almost impossible to find them in static analysis.</p><p>So we will encrypt our shellcode with <strong>encrypt_shellcode</strong> project. Then we will embed our encrypted shellcode into <strong>Injector</strong> project. When the program starts the main function will call decoder with keys. After that, the decoder will receive encrypted shellcode and checks the shellcode_len. If it is bigger than <strong>516</strong> bytes then it will receive first <strong>516</strong> byte and will decode this <strong>516</strong> byte. After that, it will subtract <strong>516</strong> bytes, which is the space we solved earlier in the size of the file. If the Remaining area is greater than 516 it will be continued in the same way. When space is less than 516 bytes, all remaining space regardless of space will be read and decoded.</p><p><img data-proofer-ignore data-src="../../assets/img/module_stomping/encryptrs-1.png" alt="Part 3" /> <em>Figure 12: Shellcode Decoder</em></p><h2 id="conclusion">Conclusion</h2><p>As a result, in this article, we examined DLL injection methods and examined <strong>AddressOfEntryPoint Injector</strong> that we developed with Rust. We’ve explained the important pieces of code inside <strong>main.rs</strong>. You can see other codes from my <a href="https://github.com/kuzeyardabulut/rust-dll-hollowing/">Github</a>. If there is a piece of code that you do not understand, you can reach me on my social media addresses.</p><p>Thanks for reading.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/malware/'>Malware</a>, <a href='/categories/windows-injection/'>Windows Injection</a>, <a href='/categories/rust/'>Rust</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/dll-hollowing/" class="post-tag no-text-decoration" >dll hollowing</a> <a href="/tags/rust/" class="post-tag no-text-decoration" >rust</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=DLL Hollowing with Rust Language: Stealth Injection - Cyber Blog&url=https://kuzey.rs/posts/RustStomping/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://telegram.me/share?text=DLL Hollowing with Rust Language: Stealth Injection - Cyber Blog&url=https://kuzey.rs/posts/RustStomping/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://kuzey.rs/posts/RustStomping/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aws-exam/">aws exam</a> <a class="post-tag" href="/tags/cve-2024-0582/">cve-2024-0582</a> <a class="post-tag" href="/tags/data-only-attack/">data-only attack</a> <a class="post-tag" href="/tags/dirty-pagetable/">dirty pagetable</a> <a class="post-tag" href="/tags/dll-hollowing/">dll hollowing</a> <a class="post-tag" href="/tags/fuzzing/">fuzzing</a> <a class="post-tag" href="/tags/guide/">guide</a> <a class="post-tag" href="/tags/io-uring-exploitation/">io_uring exploitation</a> <a class="post-tag" href="/tags/kcov/">kcov</a> <a class="post-tag" href="/tags/kernel-exploitation/">kernel exploitation</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Dirty_Page_Table/"><div class="card-body"> <span class="timeago small" >Apr 13<i class="unloaded">2025-04-13T12:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Exploiting CVE-2024-0582 via the Dirty Pagetable Method</h3><div class="text-muted small"><p> Introduction This post discusses a popular exploitation method in today’s cybersecurity community. Specifically, we’ll dive into the Dirty Pagetable method by showcasing its use on a real-world pag...</p></div></div></a></div><div class="card"> <a href="/posts/FuzzS22/"><div class="card-body"> <span class="timeago small" >Apr 8, 2024<i class="unloaded">2024-04-08T12:00:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Trying to Enable KCOV on Samsung Galaxy S22</h3><div class="text-muted small"><p> In this article, I will talk about the research I did by spending about 1.5 months on the S22 device. The primary purpose of my research was to fuzz the device by compiling the kernel with KCOV, bu...</p></div></div></a></div><div class="card"> <a href="/posts/AWS_Speciality/"><div class="card-body"> <span class="timeago small" >Jun 17, 2023<i class="unloaded">2023-06-17T00:21:00+03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>AWS Certified Security - Specialty (SCS-C01) Exam Experiences</h3><div class="text-muted small"><p> I passed the AWS Security Specialty exam about 6 months ago and became the world’s youngest aws expert at the age of 15. Today I would like to tell you about my experience in this difficult process...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/AWS_Speciality/" class="btn btn-outline-primary" prompt="Newer"><p>AWS Certified Security - Specialty (SCS-C01) Exam Experiences</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/kuzeyardabulut">Kuzey Arda Bulut</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aws-exam/">aws exam</a> <a class="post-tag" href="/tags/cve-2024-0582/">cve 2024 0582</a> <a class="post-tag" href="/tags/data-only-attack/">data only attack</a> <a class="post-tag" href="/tags/dirty-pagetable/">dirty pagetable</a> <a class="post-tag" href="/tags/dll-hollowing/">dll hollowing</a> <a class="post-tag" href="/tags/fuzzing/">fuzzing</a> <a class="post-tag" href="/tags/guide/">guide</a> <a class="post-tag" href="/tags/io-uring-exploitation/">io_uring exploitation</a> <a class="post-tag" href="/tags/kcov/">kcov</a> <a class="post-tag" href="/tags/kernel-exploitation/">kernel exploitation</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-SR892NPXLY"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-SR892NPXLY'); }); </script>
